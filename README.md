# Spectre

---

## Описание проекта

Проект выполнен в рамках участия команды разработчиков в хакатоне от РТУ МИРЭА "Код Победы".  
Название проекта `Spectre` взято в честь одной из шифровальных машин Красной Армии времён Великой Отечественной Войны.

---

## Цель проекта

- Продемонстрировать безопасную клиент-серверную систему с современным шифрованием:
  - Шифрование сообщений по схеме AES-256 (CBC + HMAC)
  - Цифровая подпись ECDSA
  - Обмен ключами (Diffie-Hellman)
  - Мониторинг целостности
- Включает тестирование на основные атаки и оценку производительности.
- Описать и реализовать схему клиент-серверного взаимодействия с использованием современных методов шифрования сообщений, обмена ключами и подписи сообщений для подтверждения целостности данных.

---

## Основные решения

1. Стандартная клиент-серверная модель.
2. Клиент и сервер сначала обмениваются публичными ключами (через протокол Диффи-Хеллмана (ECDH) для установления общей сессионной строки), затем генерируется симметричный ключ AES-256 для шифрования сеанса. После установления секретов коммуникация идёт по HTTPS-подобному протоколу: каждый запрос шифруется на клиенте и проверяется на сервере.
3. Необходимо разработать и включить схему потоков данных между клиентом и сервером (от подключения до проверки расшифрованных данных).
4. В качестве протокола передачи данных выбран HTTP. Сервис работы с письмами реализован в стиле REST-api.
5. Аутентификация на основе RSA (с использованием JWT-токенов).

---

## Описание предметной области проекта

Проект призван обеспечить безопасную передачу данных между архивом засекреченных писем, имеющих историческую ценность, и теми, кто заинтересован в работе с этими письмами в исследовательских и научных целях.

Архив писем контролируется организацией-владельцем. Архив имеет систему уровней доступа для регулирования контента, с которым работают заинтересованные лица или организации (далее "клиент").

Если клиент заинтересован в получении доступа к материалам, имеющим конкретный уровень доступа для своей исследовательской деятельности, он направляет письмо в архив или связывается с ответственными лицами иным путем с запросом на получение доступа к материалам, нужным для работы. В обращении обязаны быть описаны основания для получения соответствующего доступа и вся документация, подтверждающая истинность этих оснований.

После рассмотрения запроса ответственные лица отвечают на него. В случае положительного решения клиенту направляются данные для входа в систему работы с письмами. Вид данных и их содержание вновь определяется ответственными лицами. После получения данных клиент может войти в систему и начать свою работу. В зависимости от уровня доступа он сможет работать только с тем контентом, который соответствует его уровню.

Ответственные же лица имеют максимальный уровень доступа в системе, они вправе по собственному усмотрению вносить записи в систему, изменять их и удалять, назначать им уровни доступа и т.д. Также ответственные лица отвечают за часть работы с клиентами. При нарушении правил работы с платформой клиенту может быть закрыт доступ к системе без возможности восстановления.

---

## Техническая реализация

### Стек технологий

#### Сервер

Для реализации серверной части выбраны языки Go версии 1.24.2 и Python.

- Сервис для работы с письмами, написанный на Go, использует:
  - стандартную библиотеку для работы с сетью: `net/http`
  - внешний модуль для jwt: `github.com/golang-jwt/jwt/v5`
  - модуль для работы с миграциями базы данных: `github.com/golang-migrate/migrate/v4`
  - модуль для работы с самой базой: `github.com/mattn/go-sqlite3`
  - модуль для логирования: `github.com/sirupsen/logrus`
  - модуль для работы с базовой криптографией: `golang.org/x/crypto`
- Сервис, работающий с шифрованием, ключами и всем, что связано с криптографией, написанный на Python, использует:
  - микрофреймворк для реализации своего api: `flask`
  - модуль `cryptography` для работы с криптографией
  - модуль `gunicorn` для запуска сервиса в асинхронном режиме

#### Клиент

Клиентское взаимодействие может осуществляться с помощью desktop-клиента, написанного на Python с использованием стандартного модуля `tkinter`, или с помощью web-интерфейса, реализованного с библиотекой react-js.

#### Инфраструктура

Для развертывания сервисов используется технология контейнеризации, реализованная в виде docker-образов.

---

## Архитектура проекта

Репозиторий разделяется на основные части:
- Клиентская
- Серверная

В каждом модуле проекта присутствует собственный файл `README.md` для внутреннего документирования.

**Упрощенная схема:**
```
├── README.md  # вы тут
├── client  
│   ├── desktop
│   │   ├── dist
│   │   │   └── main.exe  # готовый исполняемый файл для Windows 
│   │   ├── main.py
│   │   └── README.md  
│   └── web
│       ├── index.html  # базовая страница
│       ├── README.md
│       └─── src
│            ├── App.css
│            ├── App.jsx 
│            ├── components  # основа приложения - react компоненты
│            ├── index.css
│            └── main.jsx
└── services  # серверная часть
    ├── docker-compose.yaml  # файл для развертывания контейнеров
    ├── crypto
    │   ├── crypto.py  # работа с криптографией
    │   ├── Dockerfile  # описание докер-образа
    │   ├── README.md
    │   ├── requirements.txt  # описание зависимостей сервиса
    │   ├── server.py  # описание api сервиса
    │   └── Tasks.md  # задачи, реализуемые сервисом
    └── spectre
        ├── db
        │   ├── migrations  # миграции базы
        │   └── spec.db  # физическая sqlite база с данными (для тестирования)
        ├── Dockerfile
        ├── README.md
        └── src  
            ├── cmd  # точки входа в приложения сервиса
            │   ├── migrator  # приложение для работы с миграциями базы
            │   └── spectre  # основное приложение
            ├── go.mod  # описание всех зависимостей сервиса
            ├── internal  # внутренняя логика
            │   ├── models  # основные предметные сущности сервиса
            │   ├── srv  # сервер
            │   │   ├── api  # api эндпоинты
            │   │   ├── auth  # работа с аутентификацией
            │   │   ├── proxy  # подключение к сервису crypto
            │   └── storage  # работа с базой
            └── pkg  # вспомогательный пакет (работа с логированием)
```

---

## Описание флоу

- Сервер занимает два порта: 5000 — spectre сервис для работы с письмами, и 7654 — crypto сервис для работы с криптографией.
- Лицо, работающее с системой, запускает один из двух клиентов.
- Происходит обмен ключами шифрования.
- Клиент вводит данные, полученные от организации, предоставляющей данные, в форму авторизации.
- Данные шифруются и отправляются к сервису писем.
- Сервис писем имеет middleware (слой, через который проходят запросы), который отслеживает данные авторизации. Там сервис spectre обращается к сервису crypto для расшифровки данных.
- В случае их корректности на сервере происходит генерация jwt-токена с timeout-полем и полем, куда записывается уровень доступа клиента. Токен подписывается с помощью HS256 (в будущем RSA) и отправляется клиенту.
- Далее при каждом запросе клиент встраивает токен в заголовки запроса.
- По умолчанию, если клиент работает с интерфейсом в вебе, ему предоставляется главная страница с письмами, доступными ему по уровню доступа.
- Если клиент — админ, он видит интерфейс для возможного изменения, удаления и добавления писем и пользователей.
- Если клиент — обычный пользователь, он может только работать с материалом в режиме read-only.
- В случае работы с desktop-приложением клиент на главной странице получает страницу получения писем. По аналогии, интерфейс изменения, добавления, удаления материалов и пользователей имеется только в том случае, когда клиент — админ.
- При получении данных письма (писем) приложение отправляет запрос на одну из ручек вида `/api/{item_kind}` или `/api/{item_kind}/{id}`, где `item_kind` — это тип сущности: `users`/`letters`.
- Обработчик сервиса spectre на сервере в соответствии с уровнем доступа клиента (хранящимся в поле jwt-токена) делает запрос к базе на получение доступных пользователю материалов, обращается к сервису crypto на ручку `/encrypt` для зашифровки данных, получает уже зашифрованные данные, дополняет ответ информацией об ошибках и совершает отправку этого ответа клиенту.
- Приложение клиента же на своей стороне производит обратную операцию расшифрования данных и отображения их в интерфейсе.
- При обновлении, добавлении производится подобный процесс с иными ручками сервиса писем.
- В случае удаления ответ сервера пуст, как и тело запроса, так как ручка вида `api/{item_kind}/{id}` уже содержит id удаляемого объекта.

**Примечание:**
Работа шифрования реализована в ветке crypto_protocol, т.к. пока полностью не завершена работа над его реализацией. Позже она будет смержена с основной.

---

## Запуск проекта

### Ручной запуск

```
git clone https://github.com/ZemskovIK/Spectre.git
cd services/crypto/
pip install -r requirements.txt
```
или ручная установка библиотек из этого файла

```
gunicorn --bind 0.0.0.0:7654 server:app --workers 3
```
для асинхронного выполнения на 3-х воркерах.

```
cd ../spectre/src/
go mod tidy
```
Запуск на большинстве Linux-дистрибутивов стабильный. На Windows возможно потребуется установка пакета компиляторов gcc и выставление опции (переменной окружения CGO).

```
go run cmd/migrator/main.go -action up
go run cmd/spectre/main.go
```
Также возможно собрать сервис в исполняемый файл командой `go build`.

Для локальной работы с web-клиентом:  
из директории `Spectre` (корня проекта) с имеющимся react и зависимостями

```
cd client/web/src/
npm run dev
```
Запустится клиент на порту 3000 (можно смотреть в браузере).

Для работы с клиентом desktop-версии:  
либо ручной запуск exe из client/desktop/dist  
либо из `Spectre`:

```
python3 main.py
```

### Docker

...

---

## Авторы

- [@ZemskovIK](https://www.github.com/ZemskovIK)
- [@kudras3r](https://www.github.com/kudras3r)
- [@Asura-code](https://www.github.com/Asura-code)
- [@justbelka](https://www.github.com/justbelka)
- [@danzyxd](https://www.github.com/danzyxd)

