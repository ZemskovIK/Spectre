# Сервис писем военных лет

## Описание проекта

Данный модуль представляет собой REST API CRUD-сервис. Он предназначен для работы с письмами военных лет, позволяя создавать, читать, обновлять и удалять записи этих исторических документов. Все данные писем передаются в зашифрованном виде.

## Флоу

Запросы и ответы к сервису описаны ниже. Основная идея работы с сервисом заключается в схеме взаимодействия вида:

- Обращение к письмам
1. ( client ) -> [ spectre ] -> [ db ]
2. [ db ] -> [ spectre ] -> [ crypto ]
3. [ crypto ] -> [ spectre ] -> ( client )

На шаге (1) клиент отправляет запрос на одну из ручек получения писем, сервис же в свою очередь обращается к хранилищу для получения писем.

На шаге (2) база возвращается сервису данные, а последний делает запрос к внешнему сервису крипто для зашифровки данных.

На шаге (3) крипто сервис возвращает шифрованные данные, которые в свою очередь сервис писем возвращает клиенту.

- Обновление / добавление писем
1. ( client ) -> [ spectre ] -> [ crypto ]
2. [ crypto ] -> [ spectre ] -> [ db ]
3. [ spectre ] -> ( client )

- Удаление не подразумевает работы с шифрованием, тк обращение происходит на ручку и все, что нужно - проверка прав пользователя, никаких данных между клиентом и сервером не передается.
 
---

## Функциональность

- **Авторизация**: Сервис работает с уровнями доступа клиента, админа.
- **Создание**: Добавление новых писем и пользователей в систему.
- **Чтение**: Получение и просмотр сохранённых писем и пользователей.
- **Обновление**: Изменение существующих записей писем.
- **Удаление**: Удаление писем и пользователей из системы.

---

## Структура модуля

- `cmd/` - Точка входа в приложение
    - `migrator/` - Приложение для создания или отката миграций
    - `spectre/` - Основное приложение
- `internal/` - Основная бизнес-логика и сервисы
    - `models/` - Модели приложения
    - `storage/` - Работа с файловой системой (базами данных)
        - `sqlite/` - Одна из реализаций базы (sqlite)
    - `srv/` - Работа с http
        - `proxy/` - Работа с обращением к внешнему сервису `crypto`
        - `lib/` - Вспомогательные функции широкого назначения
            - `methods/` - Функции для унификации методов в роутере
            - `response/` - Описание ответа
        - `api/` - Все что касается самого сервиса с письмами
            - `handlers/` - api обработчики запросов
        - `auth/` - Пакет авторизации (JWT)
- `pkg/` - Общие утилиты и вспомогательные функции
    - `logger/` - Обертка вокруг логгера (logrus)

---

## Авторизация с JWT

`POST /login`
```json
{
  "login": "login",
  "password": "pass"
}
```

**Успех (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOiIyMDI1LTA1LTIzVDE5OjM1OjIxLjkzOTA4NTY0NiswMzowMCIsInJvbGUiOjAsInN1YiI6MH0.B_WbK2YI13Cv3yju1FuQ6cGU1kE1G1_nAE8UYDgMuZA"
}
```

---

## Формат ответа API

Все ответы API имеют следующую структуру:

```python
{
  "content": { ... },   // полезная нагрузка (зашифрованные данные)
  "error": null | string, // описание ошибки, если она есть
  "iv": "base64",       // IV (инициализационный вектор) для расшифровки
  "hmac": "base64",     // HMAC для проверки целостности
  "nonce": "base64"     // nonce, если используется
}
```

- Если запрос успешен, поле `error` будет `null`.
- Все данные в поле `content` передаются в зашифрованном виде (например, как base64-строка или объект с полем `cipher_bytes`).

---

## API эндпоинты

### Получить все письма

`GET /api/letters`

**Успех (200 OK):**
```json
{
    "content": "base64string...TCm0oI...QDCCFs=",
    "error": null,
    "iv": "base64string...TCm0oI...QDCCFs=",
    "hmac": "base64string...TCm0oI...QDCCFs=",
    "nonce": "base64string...TCm0oI...QDCCFs="
}
```

**Ошибка (500 | 502):**
```json
{
  "content": null,
  "error": "error!",
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

---

### Получить письмо по ID

`GET /api/letters/{letter_id}`

**Успех (200 OK):**
```json
{
    "content": "base64string...TCm0oI...QDCCFs=",
    "error": null,
    "iv": "base64string...TCm0oI...QDCCFs=",
    "hmac": "base64string...TCm0oI...QDCCFs=",
    "nonce": "base64string...TCm0oI...QDCCFs="
}
```

**Ошибка (500 | 502 | 400 | 404 | 403):**
```json
{
  "content": null,
  "error": "error!",
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

---

### Удалить письмо по ID

`DELETE /api/letters/{letter_id}`

**Успех (200 OK):**
```json
{
  "content": null,
  "error": null,
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

**Ошибка (500 | 403 | 400 | 404):**
```json
{
  "content": null,
  "error": "error!",
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

---

### Создать новое письмо

`POST /api/letters`

**Тело запроса (application/json):**
```json
{
    "content": "base64string...TCm0oI...QDCCFs=",
    "error": null,
    "iv": "base64string...TCm0oI...QDCCFs=",
    "hmac": "base64string...TCm0oI...QDCCFs=",
    "nonce": "base64string...TCm0oI...QDCCFs="
}
```

**Успех (200 OK):**
```json
{
  "content": null,
  "error": null,
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

**Ошибка (500 | 502 | 403 | 400 | 422):**
```json
{
  "content": null,
  "error": "error!",
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

---

### Обновить письмо по ID

`PUT /api/letters/{letter_id}`

**Тело запроса (application/json):**
```json
{
    "content": "base64string...TCm0oI...QDCCFs=",
    "error": null,
    "iv": "base64string...TCm0oI...QDCCFs=",
    "hmac": "base64string...TCm0oI...QDCCFs=",
    "nonce": "base64string...TCm0oI...QDCCFs="
}
```

**Успех (200 OK):**
```json
{
  "content": null,
  "error": null,
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

**Ошибка (500 | 502 | 403 | 400 | 404):**
```json
{
  "content": null,
  "error": "error!",
  "iv": "",
  "hmac": "",
  "nonce": ""
}
```

---

## Примечания

- Все поля, связанные с шифрованием (`content`, `iv`, `hmac`, `nonce`), обязательны для корректной работы клиента.
- Клиент отвечает за расшифровку данных и проверку целостности.
- Для доступа к API требуется JWT-токен, который передаётся в заголовке `Authorization: Bearer <TOKEN>`.